AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Textbook Study Buddy MVP Backend

Parameters:
  NotificationEmail:
    Type: String
    Description: Email address for EPUB processing failure notifications
    Default: ""
  
  GoogleClientId:
    Type: String
    Description: Google OAuth Client ID for social login
    Default: ""
  
  GoogleClientSecret:
    Type: String
    Description: Google OAuth Client Secret for social login
    NoEcho: true
    Default: ""
  
  AppDomain:
    Type: String
    Description: The domain for the Cognito hosted UI (must be unique)
    Default: "quickbook-auth"

Conditions:
  HasNotificationEmail: !Not [!Equals [!Ref NotificationEmail, ""]]
  HasGoogleOAuth: !And
    - !Not [!Equals [!Ref GoogleClientId, ""]]
    - !Not [!Equals [!Ref GoogleClientSecret, ""]]

Globals:
  Function:
    Timeout: 30
    Runtime: nodejs20.x
    MemorySize: 512
    Environment:
      Variables:
        BOOKS_BUCKET: !Ref TextbookBucket
        CONTENT_TABLE: !Ref TextbookContentTable
        PROGRESS_TABLE: !Ref UserProgressTable

Resources:
  # S3 Bucket for EPUB files
  TextbookBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - PUT
              - GET
              - HEAD
            AllowedOrigins:
              - "*"
            MaxAge: 3000

  # DynamoDB Tables
  TextbookContentTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: type
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: TypeIndex
          KeySchema:
            - AttributeName: type
              KeyType: HASH
            - AttributeName: PK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  UserProgressTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE

  # =====================================================
  # COGNITO AUTHENTICATION
  # =====================================================
  
  # Cognito User Pool - Main user directory
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: quickbook-users
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      UsernameConfiguration:
        CaseSensitive: false
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
      Schema:
        - Name: email
          AttributeDataType: String
          Mutable: true
          Required: true
        - Name: name
          AttributeDataType: String
          Mutable: true
          Required: false
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      UserPoolTags:
        Application: QuickBook
  
  # Google Identity Provider (conditional)
  GoogleIdentityProvider:
    Type: AWS::Cognito::UserPoolIdentityProvider
    Condition: HasGoogleOAuth
    Properties:
      UserPoolId: !Ref CognitoUserPool
      ProviderName: Google
      ProviderType: Google
      ProviderDetails:
        client_id: !Ref GoogleClientId
        client_secret: !Ref GoogleClientSecret
        authorize_scopes: "profile email openid"
      AttributeMapping:
        email: email
        name: name
        username: sub
  
  # User Pool Domain for Hosted UI
  CognitoUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub "quickbook-auth-${AWS::AccountId}"
      UserPoolId: !Ref CognitoUserPool
  
  # User Pool Client for Web App (with Google OAuth)
  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Condition: HasGoogleOAuth
    DependsOn:
      - GoogleIdentityProvider
    Properties:
      UserPoolId: !Ref CognitoUserPool
      ClientName: quickbook-web-client
      GenerateSecret: false
      RefreshTokenValidity: 30
      AccessTokenValidity: 1
      IdTokenValidity: 1
      TokenValidityUnits:
        RefreshToken: days
        AccessToken: hours
        IdToken: hours
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_PASSWORD_AUTH
      SupportedIdentityProviders:
        - COGNITO
        - Google
      CallbackURLs:
        - http://localhost:3000
        - http://localhost:3000/
        - https://main.d12hmt15z4iuqe.amplifyapp.com
        - https://main.d12hmt15z4iuqe.amplifyapp.com/
      LogoutURLs:
        - http://localhost:3000
        - https://main.d12hmt15z4iuqe.amplifyapp.com
      AllowedOAuthFlows:
        - code
        - implicit
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      AllowedOAuthFlowsUserPoolClient: true
      PreventUserExistenceErrors: ENABLED
  
  # User Pool Client without Google (basic email/password only)
  CognitoUserPoolClientBasic:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref CognitoUserPool
      ClientName: quickbook-web-client-basic
      GenerateSecret: false
      RefreshTokenValidity: 30
      AccessTokenValidity: 1
      IdTokenValidity: 1
      TokenValidityUnits:
        RefreshToken: days
        AccessToken: hours
        IdToken: hours
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_PASSWORD_AUTH
      SupportedIdentityProviders:
        - COGNITO
      CallbackURLs:
        - http://localhost:3000
        - http://localhost:3000/
        - https://main.d12hmt15z4iuqe.amplifyapp.com
        - https://main.d12hmt15z4iuqe.amplifyapp.com/
      LogoutURLs:
        - http://localhost:3000
        - https://main.d12hmt15z4iuqe.amplifyapp.com
      AllowedOAuthFlows:
        - code
        - implicit
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      AllowedOAuthFlowsUserPoolClient: true
      PreventUserExistenceErrors: ENABLED

  # API Gateway
  TextbookApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowMethods: "'*'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
      Auth:
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt CognitoUserPool.Arn

  # Lambda Functions
  UploadFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/upload.handler
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref TextbookBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref TextbookContentTable
      Events:
        Upload:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /upload
            Method: post

  ContentFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/content.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TextbookContentTable
        - S3ReadPolicy:
            BucketName: !Ref TextbookBucket
      Events:
        GetContent:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /content/{bookId}
            Method: get

  AskFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/ask.handler
      Timeout: 60
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TextbookContentTable
        - S3ReadPolicy:
            BucketName: !Ref TextbookBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: '*'
            - Effect: Allow
              Action:
                - aws-marketplace:ViewSubscriptions
                - aws-marketplace:Subscribe
              Resource: '*'
      Events:
        Ask:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /ask
            Method: post

  SummarizeFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/summarize.handler
      Timeout: 60
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TextbookContentTable
        - S3ReadPolicy:
            BucketName: !Ref TextbookBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: '*'
            - Effect: Allow
              Action:
                - aws-marketplace:ViewSubscriptions
                - aws-marketplace:Subscribe
              Resource: '*'
      Events:
        Summarize:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /summarize
            Method: post

  GenerateQuizFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/generateQuiz.handler
      Timeout: 60
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TextbookContentTable
        - S3ReadPolicy:
            BucketName: !Ref TextbookBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: '*'
            - Effect: Allow
              Action:
                - aws-marketplace:ViewSubscriptions
                - aws-marketplace:Subscribe
              Resource: '*'
      Events:
        GenerateQuiz:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /quiz/generate
            Method: post

  GetQuestionsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/getQuestions.handler
      Timeout: 15
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TextbookContentTable
      Events:
        GetQuestions:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /questions/{bookId}
            Method: get

  EvaluateAnswerFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/evaluateAnswer.handler
      Timeout: 30
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: '*'
            - Effect: Allow
              Action:
                - aws-marketplace:ViewSubscriptions
                - aws-marketplace:Subscribe
              Resource: '*'
      Events:
        EvaluateAnswer:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /quiz/evaluate
            Method: post

  HintFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/hint.handler
      Timeout: 60
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TextbookContentTable
        - S3ReadPolicy:
            BucketName: !Ref TextbookBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: '*'
            - Effect: Allow
              Action:
                - aws-marketplace:ViewSubscriptions
                - aws-marketplace:Subscribe
              Resource: '*'
      Events:
        Hint:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /hint
            Method: post

  AgentFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/agent.handler
      Timeout: 120
      Environment:
        Variables:
          AGENT_ID: HGAOUG8YYO
          AGENT_ALIAS_ID: NVVOJM5GAY
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeAgent
              Resource: '*'
      Events:
        AgentChat:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /agent/chat
            Method: post

  ListBooksFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/listBooks.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TextbookContentTable
      Events:
        ListBooks:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /books
            Method: get

  BookStatusFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/bookStatus.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TextbookContentTable
      Events:
        GetStatus:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /books/{bookId}/status
            Method: get

  InspectContentFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/inspectContent.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TextbookContentTable
      Events:
        InspectContent:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /inspect/{bookId}
            Method: get

  ReprocessFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/reprocess.handler
      Environment:
        Variables:
          TABLE_NAME: !Ref TextbookContentTable
          BUCKET_NAME: !Ref TextbookBucket
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref TextbookBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref TextbookContentTable
      Events:
        Reprocess:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /books/{bookId}/reprocess
            Method: post

  HideBookFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/hideBook.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TextbookContentTable
      Events:
        HideBook:
          Type: Api
          Properties:
            RestApiId: !Ref TextbookApi
            Path: /books/{bookId}/hide
            Method: patch

  # SNS Topic for EPUB Processing Notifications
  EpubProcessingTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: EPUB Processing Notifications

  EpubProcessingEmailSubscription:
    Type: AWS::SNS::Subscription
    Condition: HasNotificationEmail
    Properties:
      Protocol: email
      TopicArn: !Ref EpubProcessingTopic
      Endpoint: !Ref NotificationEmail

  ProcessEpubFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/processEpub.handler
      Timeout: 300
      MemorySize: 1024
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref TextbookBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref TextbookContentTable
        - SNSPublishMessagePolicy:
            TopicName: !GetAtt EpubProcessingTopic.TopicName

  ProcessEpubFunctionEventInvokeConfig:
    Type: AWS::Lambda::EventInvokeConfig
    DependsOn:
      - ProcessEpubFunction
      - EpubProcessingTopic
    Properties:
      FunctionName: !Ref ProcessEpubFunction
      Qualifier: $LATEST
      DestinationConfig:
        OnFailure:
          Destination: !Ref EpubProcessingTopic

  HandleProcessingFailureFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/handleProcessingFailure.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TextbookContentTable
      Events:
        ProcessingFailure:
          Type: SNS
          Properties:
            Topic: !Ref EpubProcessingTopic

  ProcessEpubFunctionS3Permission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ProcessEpubFunction
      Action: lambda:InvokeFunction
      Principal: s3.amazonaws.com
      SourceArn: !Sub 'arn:aws:s3:::${TextbookBucket}'

  # Custom resource to configure S3 notifications
  S3NotificationCustomResource:
    Type: Custom::S3BucketNotification
    DependsOn: 
      - ProcessEpubFunctionS3Permission
    Properties:
      ServiceToken: !GetAtt S3NotificationFunction.Arn
      BucketName: !Ref TextbookBucket
      EpubLambdaArn: !GetAtt ProcessEpubFunction.Arn

  S3NotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.9
      Handler: index.handler
      InlineCode: |
        import json
        import boto3
        import urllib3

        s3 = boto3.client('s3')
        http = urllib3.PoolManager()

        def send_response(event, context, status, data={}):
            body = json.dumps({
                'Status': status,
                'Reason': f'See CloudWatch Log Stream: {context.log_stream_name}',
                'PhysicalResourceId': context.log_stream_name,
                'StackId': event['StackId'],
                'RequestId': event['RequestId'],
                'LogicalResourceId': event['LogicalResourceId'],
                'Data': data
            })
            http.request('PUT', event['ResponseURL'], body=body)

        def handler(event, context):
            try:
                bucket = event['ResourceProperties']['BucketName']
                
                if event['RequestType'] == 'Delete':
                    s3.put_bucket_notification_configuration(
                        Bucket=bucket,
                        NotificationConfiguration={}
                    )
                    send_response(event, context, 'SUCCESS')
                    return
                
                epub_lambda_arn = event['ResourceProperties']['EpubLambdaArn']
                
                s3.put_bucket_notification_configuration(
                    Bucket=bucket,
                    NotificationConfiguration={
                        'LambdaFunctionConfigurations': [
                            {
                                'LambdaFunctionArn': epub_lambda_arn,
                                'Events': ['s3:ObjectCreated:*'],
                                'Filter': {
                                    'Key': {
                                        'FilterRules': [{'Name': 'suffix', 'Value': '.epub'}]
                                    }
                                }
                            }
                        ]
                    }
                )
                send_response(event, context, 'SUCCESS')
            except Exception as e:
                print(f'Error: {e}')
                send_response(event, context, 'FAILED')
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref TextbookBucket
        - Statement:
            - Effect: Allow
              Action:
                - s3:PutBucketNotification
                - s3:GetBucketNotification
              Resource: !Sub 'arn:aws:s3:::${TextbookBucket}'

  # ===== BEDROCK AGENT + KNOWLEDGE BASE =====
  # Create these manually in AWS Console (eu-west-1):
  # 1. OpenSearch Serverless Collection: quickbook-vectors
  # 2. Knowledge Base: quickbook-textbooks (with S3 data source pointing to knowledge-base/ prefix)
  # 3. Bedrock Agent: quickbook-tutor (with action group pointing to ActionGroupFunction)
  # Then update AGENT_ID and AGENT_ALIAS_ID in AgentFunction environment variables above
  
  # VectorEncryptionPolicy:
#     Type: AWS::OpenSearchServerless::SecurityPolicy
#     Properties:
#       Name: quickbook-vector-encryption
#       Type: encryption
#       Policy: !Sub |
#         {
#           "Rules": [
#             {
#               "ResourceType": "collection",
#               "Resource": ["collection/quickbook-vectors"]
#             }
#           ],
#           "AWSOwnedKey": true
#         }
# 
#   VectorNetworkPolicy:
#     Type: AWS::OpenSearchServerless::SecurityPolicy
#     Properties:
#       Name: quickbook-vector-network
#       Type: network
#       Policy: !Sub |
#         [
#           {
#             "Rules": [
#               {
#                 "ResourceType": "collection",
#                 "Resource": ["collection/quickbook-vectors"]
#               },
#               {
#                 "ResourceType": "dashboard",
#                 "Resource": ["collection/quickbook-vectors"]
#               }
#             ],
#             "AllowFromPublic": true
#           }
#         ]
# 
#   # OpenSearch Serverless Collection for vector storage
#   VectorCollection:
#     Type: AWS::OpenSearchServerless::Collection
#     DependsOn:
#       - VectorEncryptionPolicy
#       - VectorNetworkPolicy
#     Properties:
#       Name: quickbook-vectors
#       Type: VECTORSEARCH
#       Description: Vector embeddings for textbook content
# 
#   # IAM Role for Knowledge Base
#   KnowledgeBaseRole:
#     Type: AWS::IAM::Role
#     Properties:
#       AssumeRolePolicyDocument:
#         Version: '2012-10-17'
#         Statement:
#           - Effect: Allow
#             Principal:
#               Service: bedrock.amazonaws.com
#             Action: sts:AssumeRole
#       ManagedPolicyArns:
#         - arn:aws:iam::aws:policy/AmazonBedrockFullAccess
#       Policies:
#         - PolicyName: S3Access
#           PolicyDocument:
#             Version: '2012-10-17'
#             Statement:
#               - Effect: Allow
#                 Action:
#                   - s3:GetObject
#                   - s3:ListBucket
#                 Resource:
#                   - !GetAtt TextbookBucket.Arn
#                   - !Sub '${TextbookBucket.Arn}/*'
#         - PolicyName: OpenSearchAccess
#           PolicyDocument:
#             Version: '2012-10-17'
#             Statement:
#               - Effect: Allow
#                 Action:
#                   - aoss:APIAccessAll
#                 Resource: !GetAtt VectorCollection.Arn
# 
#   VectorAccessPolicy:
#     Type: AWS::OpenSearchServerless::AccessPolicy
#     Properties:
#       Name: quickbook-vector-access
#       Type: data
#       Policy: !Sub |
#         [
#           {
#             "Rules": [
#               {
#                 "ResourceType": "collection",
#                 "Resource": ["collection/quickbook-vectors"],
#                 "Permission": [
#                   "aoss:CreateCollectionItems",
#                   "aoss:DeleteCollectionItems",
#                   "aoss:UpdateCollectionItems",
#                   "aoss:DescribeCollectionItems"
#                 ]
#               },
#               {
#                 "ResourceType": "index",
#                 "Resource": ["index/quickbook-vectors/*"],
#                 "Permission": [
#                   "aoss:CreateIndex",
#                   "aoss:DeleteIndex",
#                   "aoss:UpdateIndex",
#                   "aoss:DescribeIndex",
#                   "aoss:ReadDocument",
#                   "aoss:WriteDocument"
#                 ]
#               }
#             ],
#             "Principal": [
#               "${KnowledgeBaseRole.Arn}"
#             ]
#           }
#         ]
# 
#   # Bedrock Knowledge Base
#   TextbookKnowledgeBase:
#     Type: AWS::Bedrock::KnowledgeBase
#     DependsOn:
#       - VectorCollection
#       - VectorAccessPolicy
#     Properties:
#       Name: quickbook-textbooks
#       RoleArn: !GetAtt KnowledgeBaseRole.Arn
#       KnowledgeBaseConfiguration:
#         Type: VECTOR
#         VectorKnowledgeBaseConfiguration:
#           EmbeddingModelArn: !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-embed-text-v1'
#       StorageConfiguration:
#         Type: OPENSEARCH_SERVERLESS
#         OpensearchServerlessConfiguration:
#           CollectionArn: !GetAtt VectorCollection.Arn
#           VectorIndexName: textbook-index
#           FieldMapping:
#             VectorField: embedding
#             TextField: content
#             MetadataField: metadata
# 
#   # S3 Data Source for Knowledge Base
#   KnowledgeBaseDataSource:
#     Type: AWS::Bedrock::DataSource
#     Properties:
#       KnowledgeBaseId: !Ref TextbookKnowledgeBase
#       Name: textbook-chunks
#       DataSourceConfiguration:
#         Type: S3
#         S3Configuration:
#           BucketArn: !GetAtt TextbookBucket.Arn
#           BucketOwnerAccountId: !Ref AWS::AccountId
#           InclusionPrefixes:
#             - knowledge-base/
#       VectorIngestionConfiguration:
#         ChunkingConfiguration:
#           ChunkingStrategy: NONE
# 
#   # IAM Role for Bedrock Agent
#   AgentRole:
#     Type: AWS::IAM::Role
#     Properties:
#       AssumeRolePolicyDocument:
#         Version: '2012-10-17'
#         Statement:
#           - Effect: Allow
#             Principal:
#               Service: bedrock.amazonaws.com
#             Action: sts:AssumeRole
#       ManagedPolicyArns:
#         - arn:aws:iam::aws:policy/AmazonBedrockFullAccess
#       Policies:
#         - PolicyName: KnowledgeBaseAccess
#           PolicyDocument:
#             Version: '2012-10-17'
#             Statement:
#               - Effect: Allow
#                 Action:
#                   - bedrock:Retrieve
#                   - bedrock:RetrieveAndGenerate
#                 Resource: !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/${TextbookKnowledgeBase}'
#         - PolicyName: ActionGroupLambdaInvoke
#           PolicyDocument:
#             Version: '2012-10-17'
#             Statement:
#               - Effect: Allow
#                 Action:
#                   - lambda:InvokeFunction
#                 Resource: !GetAtt ActionGroupFunction.Arn

  # Action Group Lambda Function
  ActionGroupFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
    Properties:
      CodeUri: ./
      Handler: src/handlers/actionGroup.handler
      Timeout: 60
      Environment:
        Variables:
          CONTENT_TABLE: !Ref TextbookContentTable
          PROGRESS_TABLE: !Ref UserProgressTable
          BOOKS_BUCKET: !Ref TextbookBucket
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TextbookContentTable
        - DynamoDBCrudPolicy:
            TableName: !Ref UserProgressTable
        - S3ReadPolicy:
            BucketName: !Ref TextbookBucket
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: '*'

  # Permission for Bedrock to invoke Action Group Lambda (uses hardcoded agent ID)
  ActionGroupFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ActionGroupFunction
      Action: lambda:InvokeFunction
      Principal: bedrock.amazonaws.com
      SourceArn: !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent/HGAOUG8YYO'

#   # Bedrock Agent (created manually in console)
#   TutorAgent:
#     Type: AWS::Bedrock::Agent
#     DependsOn: ActionGroupFunction
#     Properties:
#       AgentName: quickbook-tutor
#       AgentResourceRoleArn: !GetAtt AgentRole.Arn
#       FoundationModel: anthropic.claude-3-haiku-20240307-v1:0
#       Instruction: |
#         You are an expert AI tutor helping students learn from textbooks.
#         
#         Your role:
#         - Answer questions clearly with examples from the textbook
#         - Use the Socratic method to guide learning
#         - Generate practice problems when appropriate using the generateQuiz tool
#         - Provide progressive hints using the getHint tool (never give direct answers immediately)
#         - Evaluate student answers using the evaluateAnswer tool
#         - Track student progress to personalize the learning experience
#         - Be patient, encouraging, and focus on understanding over memorization
#         
#         When a student asks a question:
#         1. Search the knowledge base for relevant content
#         2. Provide a clear explanation with context from the textbook
#         3. Offer to generate practice problems or provide examples
#         4. Ask follow-up questions to check understanding
#         
#         When to use tools:
#         - Use generateQuiz when the student wants to practice or after explaining a concept
#         - Use getHint when a student is stuck on a problem (start with level 1, increase if they need more help)
#         - Use evaluateAnswer when a student submits an answer to check their understanding
#         - Use trackProgress to record completed activities and scores
#         - Use getLearningSummary to review a student's progress and tailor recommendations
#         
#         Always cite specific sections or theorems when referencing the textbook.
#       KnowledgeBases:
#         - KnowledgeBaseId: !Ref TextbookKnowledgeBase
#           Description: Textbook content with LaTeX equations and examples
#           KnowledgeBaseState: ENABLED
#       ActionGroups:
#         - ActionGroupName: tutoring-tools
#           Description: Tools for interactive tutoring including quiz generation, hints, and progress tracking
#           ActionGroupExecutor:
#             Lambda: !GetAtt ActionGroupFunction.Arn
#           FunctionSchema:
#             Functions:
#               - Name: generateQuiz
#                 Description: Generate practice quiz questions based on the textbook chapter content. Use this when a student wants to test their understanding or after explaining a concept.
#                 Parameters:
#                   chapterNumber:
#                     Description: The chapter number to generate questions from
#                     Required: true
#                     Type: integer
#                   topic:
#                     Description: Specific topic within the chapter to focus on (optional)
#                     Required: false
#                     Type: string
#                   difficulty:
#                     Description: Difficulty level - easy, medium, or hard
#                     Required: false
#                     Type: string
#                   questionCount:
#                     Description: Number of questions to generate (default 5)
#                     Required: false
#                     Type: integer
#               - Name: getHint
#                 Description: Get a progressive hint for a question. Start with level 1 (subtle nudge) and increase to level 2 (moderate guidance) or level 3 (detailed explanation) if the student needs more help.
#                 Parameters:
#                   chapterNumber:
#                     Description: The chapter number for context
#                     Required: true
#                     Type: integer
#                   question:
#                     Description: The question the student needs help with
#                     Required: true
#                     Type: string
#                   hintLevel:
#                     Description: Hint level from 1 (subtle) to 3 (detailed). Always start with 1 and increase if needed.
#                     Required: true
#                     Type: integer
#               - Name: evaluateAnswer
#                 Description: Evaluate a student's answer to a question and provide feedback
#                 Parameters:
#                   question:
#                     Description: The question that was asked
#                     Required: true
#                     Type: string
#                   studentAnswer:
#                     Description: The student's answer to evaluate
#                     Required: true
#                     Type: string
#                   correctAnswer:
#                     Description: The expected correct answer (if known)
#                     Required: false
#                     Type: string
#               - Name: trackProgress
#                 Description: Track student activity and progress for personalized learning
#                 Parameters:
#                   chapterNumber:
#                     Description: The chapter number being studied
#                     Required: true
#                     Type: integer
#                   activity:
#                     Description: Type of activity (e.g., 'study', 'quiz', 'practice')
#                     Required: true
#                     Type: string
#                   score:
#                     Description: Score achieved (0.0 to 1.0) if applicable
#                     Required: false
#                     Type: number
#               - Name: getLearningSummary
#                 Description: Get a summary of the student's learning progress for the book
#                 Parameters: {}
# 
#   AgentAlias:
#     Type: AWS::Bedrock::AgentAlias
#     Properties:
#       AgentId: !GetAtt TutorAgent.AgentId
#       AgentAliasName: production
# 
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${TextbookApi}.execute-api.${AWS::Region}.amazonaws.com/prod/'
  BooksBucket:
    Description: S3 bucket for EPUB files
    Value: !Ref TextbookBucket
  EpubProcessingTopicArn:
    Description: SNS Topic ARN for EPUB processing notifications
    Value: !Ref EpubProcessingTopic
  ProcessEpubFunctionArn:
    Description: Lambda function ARN for S3 notification configuration
    Value: !GetAtt ProcessEpubFunction.Arn
  ProcessEpubFunctionName:
    Description: Lambda function name for S3 notification configuration
    Value: !Ref ProcessEpubFunction
  
  # Cognito Outputs
  CognitoUserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref CognitoUserPool
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolId"
  
  CognitoUserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !If [HasGoogleOAuth, !Ref CognitoUserPoolClient, !Ref CognitoUserPoolClientBasic]
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolClientId"
  
  CognitoUserPoolDomainUrl:
    Description: Cognito Hosted UI Domain
    Value: !Sub "https://${AppDomain}-${AWS::AccountId}.auth.${AWS::Region}.amazoncognito.com"
    Export:
      Name: !Sub "${AWS::StackName}-CognitoDomain"
  
  CognitoRegion:
    Description: AWS Region for Cognito
    Value: !Ref AWS::Region
